<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
    <title>订单结算</title>
    <link rel="stylesheet" href="Public/css/common/public.css">
	<link rel="stylesheet" href="Public/css/common/weui.css">
    <link rel="stylesheet" type="text/css" href="Public/css/home/mall.css">
    <link rel="stylesheet" href="Public/js/common/layer.mobile/need/layer.css">
</head>
<body>
<!--代金券模板-->
<div id="vouchersUseList" style="display:none;">
    <section class="purchase_voucher">
        <p>使用规则：一次只能用一张；请在有效日期前使用</p>
        <div class="purchase_voucher_item cp_voucher" data-voucher="">
            <div class="p_v_l">
                <span class="p_voucher"><price>100</price>元</span>
                <span>产品代金券</span>
            </div>
            <div class="p_v_r">
                <span>获得日期</span>
                <span>2017年08月28日</span>
                <span>失效日期</span>
                <span>2017年09月28日</span>
            </div>
        </div>
        <div class="purchase_voucher_item yq_voucher" data-voucher="">
            <div class="p_v_l">
                <span class="p_voucher"><price>1000</price>元</span>
                <span>仪器代金券</span>
            </div>
            <div class="p_v_r">
                <span>获得日期</span>
                <span>2017年08月28日</span>
                <span>失效日期</span>
                <span>2017年09月28日</span>
            </div>
        </div>  
    </section>
</div>
<article class="msh_product_picture f24">
    <section class="purchase_head_title">
        <h2>订单金额</h2>
    </section>
    <section class="purchase_voucher_option">
        <div class="order_amount_item">订单金额：<i>￥</i><span><price>1000</price></span></div>
        <div class="purchase_v_item">
            <a href="javascript:;" class="voucher_number">可使用的代金券<span>(现有2张)</span></a>
        </div>
        <div class="purchase_v_item">
            <span>可抵扣金额：</span>
            <span class="voucherListValue">-￥<price>0</price></span>
        </div>
        <div class="purchase_v_item">使用推客收益账户自动扣除
            <span>(余额￥<price class="demand_balance">100.00</price>)</span>
        </div>
        <div class="purchase_v_item">
            <span>可扣除金额：</span>
            <span>-￥<price class="deduction_twitter_money">0</price></span>
        </div>
        <div class="purchase_v_item">使用采购充值账户自动扣除
            <span>(余额￥<price class="purchase_balance">400.00</price>)</span>
        </div>
        <div class="purchase_v_item">
            <span>可扣除金额：</span>
            <span>-￥<price class="deduction_purchase_money">0</price></span>
        </div>
    </section>
    <section class="purchase_v_pay">
        <div class="amount_pay">需支付金额：
            <span>￥<price>0</price></span>
        </div>
    </section>
</article>
<footer class="f24 group_cart_nav">
    <a href="javascript:void(0);" class="bff6482 group_btn100">结算</a>
</footer>
<script src="Public/js/common/jquery-1.11.3.min.js"></script>
<script src="Public/js/common/layer.mobile/layer.js"></script>
<script src="public/js/common/public.js"></script>
<script src="public/js/common/common.js"></script>
<script src="public/js/common/dialog.js"></script>
<script type="text/javascript">
    $(function(){
        var vouchersUseList=$('#vouchersUseList').html();
        $('body').on('click','.voucher_number',function(){
            var voucherLayerValue;
            layer.open({
                btn:['确定','取消'],
                title:['可用的代金券','border-bottom:1px solid #d9d9d9;'],
                className:'purchase_voucher_layer',
                content:vouchersUseList,
                success:function(){                    
                    $('.purchase_voucher_item').on('click',function(){
                        $(this).addClass('current').siblings().removeClass('current');
                        voucherLayerValue=$(this).find('.p_voucher').find('price').text();
                    })
                    $.each($('.purchase_voucher_item'), function(i,val){ 
                       
                    });
                },
                yes:function(index){
                    $('.voucherListValue').find('price').text(voucherLayerValue);
                    calculateOrderAmount(parseInt(voucherLayerValue));
                    layer.close(index);
                }
            })     
        });
    });
    //calculateOrderAmount();
    function calculateOrderAmount(voucherAmount){
        var discount;//扣除代金券差价
        var twitterDiscount;//扣除推客余额差价
        var purchaseDiscount;//扣除推客余额差价
        alert(typeof voucherAmount);
        var order_amount = $('.order_amount_item').find('price').text();
        var demandBalanceAmount=$('.demand_balance').text();//推客收益余额
        var purchaseBalance=$('.purchase_balance').text();//采购账户充值余额
        if(!isMoney(order_amount)){
            dialog.error('订单金额不是金额');
            return false;
        }
        if(order_amount<=voucherAmount){
            $('.amount_pay price').text(0);
            $('.voucherListValue price').text(order_amount);
            $('.deduction_twitter_money,.deduction_purchase_money').text(0);
            return false;
        }else{
            alert(1);
            discount=order_amount-voucherAmount;
            if(discount<=demandBalanceAmount){
                $('.deduction_twitter_money').text(discount);
                $('.demand_balance').text(demandBalanceAmount-discount);
                $('.amount_pay price').text(0);
            }else{
                $('.deduction_twitter_money').text(demandBalanceAmount);
                $('.demand_balance').text(0);
                twitterDiscount=discount-demandBalanceAmount;
                if(twitterDiscount<=purchaseBalance){
                    $('.deduction_purchase_money').text(twitterDiscount);
                    $('.purchase_balance').text(purchaseBalance-twitterDiscount);
                    $('.amount_pay price').text(0);
                }else{
                    purchaseDiscount=twitterDiscount-purchaseBalance;
                    $('.purchase_balance').text(0);
                    $('.deduction_purchase_money').text(purchaseBalance);
                    $('.amount_pay price').text(purchaseDiscount);
                }
            }
        }
    }
</script>
</body>
</html>